# RepoGenome Integration Rules

## Core Principle

**Always use RepoGenome for codebase analysis. Never manually scan files or search the repository directly.**

## Quick Start

**First action in every session:**
- Load `repogenome://summary?mode=brief` for minimal context (entry_points, core_domains)

**If genome missing:** Use `repogenome.scan(scope="full", incremental=false)`

**If genome stale:** Use `repogenome.validate()` then `repogenome.scan(incremental=true)`

## Common Workflows

### Understanding Codebase Structure
1. Start minimal: `repogenome://summary?mode=brief`
2. Get stats: `repogenome://stats` or `repogenome.stats()`
3. Expand as needed: `repogenome://summary?mode=detailed` or `repogenome://current/brief`

### Finding Files/Functions
1. Discovery phase (minimal context): `repogenome.query(query="search terms", ids_only=true, page=1, page_size=50)`
2. Get details selectively: `repogenome.get_node(node_id="node.id", fields=["id", "type", "file", "summary"], max_depth=0)`

### Analyzing Dependencies
- `repogenome.get_node(node_id="target", fields=["id", "incoming_edges", "outgoing_edges"], max_depth=1)`
- Or: `repogenome.dependencies(node_id="target", direction="both", depth=1)`

### Before Making Changes
- `repogenome.impact(affected_nodes=["node.id"], operation="modify")`

### After Making Changes
- `repogenome.update(reason="description of changes")` - **MANDATORY after any code edits**

## Context Reduction Strategies

**Minimize token usage by requesting only what you need:**

1. **Start Brief, Expand Gradually**
   - Initial load: `repogenome://summary?mode=brief` (minimal)
   - Standard analysis: `repogenome://summary` (standard mode)
   - Deep dive: `repogenome://summary?mode=detailed` or `repogenome://current`

2. **Use Field Selection**
   - Request only needed fields: `fields=["id", "type", "file"]` or `fields="id,type,file"`
   - Field aliases: `t` → `type`, `f` → `file`, `s` → `summary`, `c` → `criticality`, `lang` → `language`, `v` → `visibility`

3. **Use IDs-Only for Discovery**
   - For large result sets: `repogenome.query(query="functions", ids_only=true, page=1, page_size=100)`
   - Then fetch details selectively with `get_node()`

4. **Limit Relationship Depth**
   - `max_depth=0`: Node data only (no relationships)
   - `max_depth=1`: Direct relationships only (default)
   - `max_depth=2+`: Multiple levels (use sparingly)

5. **Filter Edges Selectively**
   - `include_edges=false` - No edges
   - `edge_types=["calls", "imports"]` - Only specific edge types

6. **Truncate Summaries**
   - `max_summary_length=100` - Limit summary text length

7. **Use Resource Variants**
   - `repogenome://current/brief` - Lite version (essential fields)
   - `repogenome://current/detailed` - Enhanced with metrics
   - `repogenome://summary?mode=brief` - Minimal summary
   - `repogenome://summary?mode=detailed` - Enhanced summary

## Available Tools

### Query & Search
- **`repogenome.query`** - Query with pagination and field selection
  - Parameters: `query`, `fields`, `ids_only`, `max_summary_length`, `page`, `page_size`, `filters`
- **`repogenome.search`** - Advanced search with filters
  - Parameters: `query`, `node_type`, `language`, `file_pattern`, `limit`
- **`repogenome.get_node`** - Get node details
  - Parameters: `node_id` (required), `fields`, `max_depth`, `include_edges`, `edge_types`
- **`repogenome.dependencies`** - Get dependency graph
  - Parameters: `node_id` (required), `direction`, `depth`

### Analysis & Management
- **`repogenome.scan`** - Generate/regenerate genome
  - Parameters: `scope` ("full", "structure", "flows", "history"), `incremental`
- **`repogenome.stats`** - Get repository statistics
- **`repogenome.impact`** - Check change impact
  - Parameters: `affected_nodes` (array), `operation` ("modify", "delete", "add")
- **`repogenome.update`** - Update genome after changes (MANDATORY after edits)
  - Parameters: `reason` (string)
- **`repogenome.validate`** - Validate genome consistency
- **`repogenome.export`** - Export to different formats
  - Parameters: `format` ("json", "csv", "cypher", "plantuml", "graphml", "dot"), `output_path`

## Available Resources

### Summary Resources (Start Here)
- `repogenome://summary?mode=brief` - **Minimal** (entry_points, core_domains)
- `repogenome://summary` - **Standard** (all summary fields)
- `repogenome://summary?mode=detailed` - **Enhanced** (standard + metrics)

### Genome Resources
- `repogenome://current` - Full genome
- `repogenome://current/brief` - Lite version (essential fields)
- `repogenome://current/detailed` - Enhanced with metrics

### Other Resources
- `repogenome://stats` - Repository statistics
- `repogenome://diff` - Changes since last update
- `repogenome://nodes/{node_id}` - Node data
- `repogenome://nodes/{node_id}?fields=id,type` - Node with field selection

## Decision Tree

**Need to understand codebase?**
- Quick overview → `repogenome://summary?mode=brief`
- Standard analysis → `repogenome://summary`
- Deep analysis → `repogenome://summary?mode=detailed` or `repogenome://current`

**Need to find something?**
- Large result set → `repogenome.query(..., ids_only=true)` then `get_node()` for details
- Small result set → `repogenome.query(..., fields=["id", "type", "file"])`
- Specific search → `repogenome.search(...)`

**Need node details?**
- Node only → `get_node(..., max_depth=0, fields=["id", "type", "file"])`
- With relationships → `get_node(..., max_depth=1)`
- Specific edges → `get_node(..., edge_types=["calls"])`

## Key Principles

1. **RepoGenome First** - Always use RepoGenome, never manual file operations
2. **Minimize Context** - Request only needed fields and data
3. **Start Brief** - Begin with minimal context, expand as needed
4. **Use IDs-Only for Discovery** - Get IDs first, fetch details selectively
5. **Leverage Caching** - Query results are cached automatically
6. **Keep Updated** - Always call `repogenome.update()` after code changes
7. **Validate When Needed** - Use `repogenome.validate()` if operations seem inconsistent

## Fallback (If RepoGenome Unavailable)

**Only if RepoGenome tools/resources are not available:**
1. Check if `repogenome.json` exists in repository root
2. If exists, read it directly (it's JSON)
3. If missing, inform user that RepoGenome should be set up first
4. Never proceed with manual file scanning as primary method

